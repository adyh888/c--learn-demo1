<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>MQTTè®¾å¤‡ç›‘æ§</title>
    <style>
        body {
            font-family: Arial;
            max-width: 1200px;
            margin: 50px auto;
        }

        .device-card {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 10px;
            border-radius: 5px;
            display: inline-block;
            width: 300px;
        }

        .value {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
<h1>ğŸ­ MQTTè®¾å¤‡å®æ—¶ç›‘æ§</h1>

<div>
    <button onclick="connectMqtt()">è¿æ¥MQTT</button>
    <button onclick="publishTest()">å‘å¸ƒæµ‹è¯•æ¶ˆæ¯</button>
    <span id="status">æœªè¿æ¥</span>
</div>

<div id="devices"></div>

<script>
    let client = null;
    const devices = {};

    function connectMqtt() {
        client = mqtt.connect('ws://broker.emqx.io:8083/mqtt');

        client.on('connect', () => {
            document.getElementById('status').textContent = 'âœ… å·²è¿æ¥';
            console.log('MQTTè¿æ¥æˆåŠŸ');

            // è®¢é˜…æ‰€æœ‰è®¾å¤‡æ•°æ®
            client.subscribe('factory/device/+/data');
            client.subscribe('factory/device/+/status');
        });

        client.on('message', (topic, message) => {
            const data = JSON.parse(message.toString());
            console.log('æ”¶åˆ°æ¶ˆæ¯:', topic, data);

            if (topic.includes('/data')) {
                updateDeviceData(data);
            }
        });
    }

    function updateDeviceData(data) {
        devices[data.deviceId] = data;
        renderDevices();
    }

    function renderDevices() {
        const container = document.getElementById('devices');
        container.innerHTML = Object.values(devices).map(device =>
            `
                <div class="device-card">
                    <h3>è®¾å¤‡ ${device.DeviceId}</h3>
                    <div class="value">${device.Value && device.Value.toFixed(2)} ${device.Unit}</div>
                    <div>${device.DataType}</div>
                    <div>æ—¶é—´: ${new Date(device.Timestamp).toLocaleTimeString()}</div>
                </div>
            `).join('');
    }

    function publishTest() {
        if (!client) {
            alert('è¯·å…ˆè¿æ¥MQTT');
            return;
        }

        const message = {
            DeviceId: 999,
            DataType: 'temperature',
            Value: 25.5,
            Unit: 'Â°C',
            Timestamp: new Date().toISOString()
        };

        client.publish('factory/device/999/data', JSON.stringify(message));
        console.log('å‘å¸ƒæµ‹è¯•æ¶ˆæ¯');
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
    window.onload = () => {
        connectMqtt();
    };
</script>
</body>
</html>